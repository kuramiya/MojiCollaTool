# 開発メモ

## 実装したい機能
### 必須機能
- コラ画像の読み込み
  - jpg
  - png
  - ~~bmp~~　需要がなさそうなので、今のところ実装しない
  - 画像のみ読み出す
  - すべて新規にする

- 画面上の表示の変更
  - 拡大・縮小
  - パニング（拡大表示場所の移動）

- 文字の追加
- 文字の複製
- 文字の削除

- 文字のマウスドラッグによる移動
- 文字のダブルクリックによる設定画面呼び出し

- 文字の装飾
  - 横書き or 縦書き
  - 文字サイズの変更
  - フォントの変更
  - 書体の変更
    - 太文字
    - イタリック文字
  - 文字間隔の変更
  - 行間隔の変更
  - 文字色の変更
  - 文字の縁取り
    - 縁取り幅の変更
    - 縁取り色の変更
    - 縁取りのぼかし
  - 文字の箱背景
    - 背景色の変更
    - 背景の縁取り色の変更
    - 背景の縁取り幅の変更

- プロジェクトの保存機能
  - 専用拡張子でのファイル保存

- 画像としての出力
  - 出力形式
    - jpg
    - png

### できれば欲しい機能
- 画像の色のスポイト機能（できれば）
- 文字の整列機能
- 画像の結合機能
- 文字の傾け機能

## 開発環境など
- Visual Studio C# 2022
- .NET 6.0
- WPF

## UI設計
### ユーザーストーリーA
1. 画像のロード
1. 文字の追加
1. 文字の配置（移動）
1. 文字の装飾
1. 画像の出力
### ユーザーの実行環境
- Windows10, 11
  - Win7は考えない
- 画面サイズ
  - 1920 x 1080 (Full HD)以上

### デザインの要点
- 読み出し、保存などの出番はそれほど多くない
- 文字の追加、装飾処理の使い勝手が一番肝心
- 色の選択は容易にしたい
  - 色の使用履歴が欲しい

### 画面設計

#### メイン画面
##### 画面サイズ
1200 x 675 (16:9)
変更可能

- 上にツールバーを配置する
  - 画像読み出しボタン
  - プロジェクト読み出しボタン
  - プロジェクト保存ボタン
  - 画像出力ボタン
  - 文字追加ボタン

- 左パネル
  - 画像パネル
　- 文字パネルのドラッグによる操作
  - 文字パネルのクリックによる文字入力画面の表示

- 右パネル
  - 追加した文字一覧のリスト
    - ID列
    - テキスト冒頭列
    - クリックすることでその文字入力画面を表示する

#### 文字入力画面
- 上部ツールバー
  - 識別IDラベル
  - 複製ボタン
  - 削除ボタン
- 座標（X, Y）（デフォルトは0, 0）
- 入力文字テキストボックス（デフォルトは「サンプル」）
- フォント（デフォルトは未定）
- 縦書きor横書き（デフォルトは横書き）
- 文字サイズ（デフォルトは未定）
- 文字間隔（デフォルトは0）
- 行間隔（デフォルトは0）
- 文字色（デフォルトは黒）
- 文字の縁取り幅（デフォルトは0）
- 文字の縁取り色（デフォルトは白）
- 文字のぼかし（デフォルトは0）
- 文字の背景色（デフォルトは透明）
- 文字の背景縁取り幅（デフォルトは0）
- 文字の背景縁取り色（デフォルトは黒）

#### 画面設計問題点
- テキスト入力に大きな領域が欲しい、しかし、それを取ると画像が見にくくなる
  - 別画面にしたほうが良いのではないか？
  - そうなると文字入力コントロール自体を別画面にしたほうが良さそう

## 各機能の実装

### 文字の縦書き処理対応

#### 参考リンク集
- https://ja.wikipedia.org/wiki/%E7%B4%84%E7%89%A9　約物
- https://swift-smooth.com/symbol-parenthesis/　かっこ一覧
- https://learn.microsoft.com/ja-jp/dotnet/desktop/wpf/graphics-multimedia/transforms-overview?view=netframeworkdesktop-4.8
- https://learn.microsoft.com/ja-jp/dotnet/desktop/wpf/advanced/how-to-flip-a-uielement-horizontally-or-vertically?view=netframeworkdesktop-4.8
- 
#### 実装メモ
かっこについては、エンコードできないもの、普通は使わなさそうなものは排除しておく。
カッコや＝ーの場合、縦書き時は右90°回転となる。
、。などは、縦書き時は右上にずらす。幅と高さからずらし幅を算出する。

### 文字の装飾処理
CharDecoration.mdを参照。
[CharDecoration.md](/CharDecoration.md)

### カラーピッカーの実装
ColorPicker.mdを参照。
[ColorPicker.md](/ColorPicker.md)

### キャンバスエディタの実装
CanvasEditor.mdを参照。
[CanvasEditor.md](/CanvasEditor.md)

### 画面の拡大、縮小機能

#### 参考リンク集
- http://cswpf.seesaa.net/article/317340776.html

#### 実装メモ
ScrollViewr -> Canvas -> Imageの順で構成されている。
Canvasを拡大、縮小すれば良い。

画像出力する際は、拡大、縮小された状態で出力される可能性がある。
実際そのように出力された。
出力する直前に倍率を100%に戻し、出力後に設定前に戻すことで解決した。
力技だがひとまずそれで対応済みとしておく。

実際実行したところ、出力サイズがおかしなデータがあった。
jpgでDPI設定が96ではない場合、小さく表示されてしまう。
96DPIの画像に切り替える仕組みをいれて対処。

### データ保存処理

#### 参考リンク集
- https://csharp.keicode.com/topics/create-zipfile.php
  - ZipFileクラスのメソッドは、フォルダをまとめた場合そのフォルダ自体は圧縮対象に含めない、中身のみ圧縮する

#### 実装仕様
作業ディレクトリにデータを出力し、それをzipファイルでまとめる。
中に情報を書き込んだテキストファイルを書いておく。
mctzipという拡張子にする。

### 画像編集機能
指定した色で広げる
画像方式、データなどなど考え直す必要あり


## 懸念点、その他

### 未解決
- 文字の背景色の範囲をどのように指定するか？
  - プロポーショナルフォントの影響を受けないか？
- 文字の追加が遅い
- 文字ウィンドウを最初に開くのが遅い

### バグ
- 縦書きで行を追加した場合、右にずれる
- システムにあるフォントが正しく表示されない
- プロジェクト読み出し時に古いデータが残っている
  - 前回終了時のデータが作業ディレクトリに残ったままで画像をロードすると、

## 追加したい機能
- 画像サイズ変更、背景を単色で塗り拡げる
- 複数の画像の連結機能

### 解決済み
- 縦書き文字をどのように実装するか？
  - かっこや伸ばし棒などを、どのように縦書き配置にするか？
   - リストを用意し、それを90度回転させることで対処する
  - プロポーショナルフォントの縦書き配置をどのようにするか？
   - 細かい配置方法は諦める
  - 空行の処理がおかしい、半角が半角サイズとなる
- パネル上でのダブルクリックの実装
  - ダブルクリックのイベントは存在しないので、自力で実装する必要がある
  - とりあえず普通のクリックで対処する
  - ContentControlを上位に配置することで解決した
- 文字編集のクリックが文字の上でない限り反応しない
  - ContentControlのダブルクリックはそういう仕組みらしい？
- 画像の拡大と縮小が、画像の出力に影響しないか？
- 既存の文字をクリックしても、文字画面がフォーカスされない
- 文字を複製した場合、文字の縦横が横にリセットされている
- 文字を複製した場合、文字のぼかし幅がリセットされている
- フォント次第では、文字の縁取りが一部削除されている
- 上書き保存を行おうとすると、フォルダの中にアクセスしてしまう
- 文字の斜め配置機能（効果音のため）
